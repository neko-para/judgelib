#!/bin/bash
CC=gcc
AS=as
BIT=$1

if [ -z "$BIT" ]; then
	BIT=64
fi
CFLAGS="$CFLAGS -fPIC -g -m$BIT -D_JUDGE_BIT_=$BIT"

mkdir -p .build

for i in *.c; do
	j=$(echo $i | sed 's/\.c//')
	SYS=("${SYS[@]}" "$j")
	SYSOBJ=("${SYSOBJ[@]}" ".build/$j.o")
done

cat > Makefile << EOF
PREFIX=/usr/local/judgelib

all: libjudge.so test

Makefile: gen
	./gen
	make

clean:
	-rm -f libjudge.so
	-rm -f ${SYSOBJ[@]} test crt.o

install: all
	mkdir -p \$(PREFIX)
	mkdir -p \$(PREFIX)/include
	mkdir -p \$(PREFIX)/lib
	for i in *.h; do install \$\$i \$(PREFIX)/include/\$\$i; chmod 644 \$(PREFIX)/include/\$\$i; done
	rm \$(PREFIX)/include/syscall.h
	install crt.o \$(PREFIX)/lib/crt.o
	install libjudge.so \$(PREFIX)/lib/libjudge.so

crt.o: Makefile crt${BIT}.s
	$AS -o crt.o crt${BIT}.s --${BIT}

test: Makefile test.cpp crt.o
	$CC -o test test.cpp crt.o ${CFLAGS} ${LDFLAGS} -nostdlib -I. -L. -ljudge -Wl,--rpath=. -fno-builtin-printf

libjudge.so: ${SYSOBJ[@]}
	$CC -shared -o libjudge.so ${SYSOBJ[@]} ${CFLAGS} ${LDFLAGS} -lm

EOF
echo Building deps
mkdir -p .build
for i in ${SYS[@]}; do
	echo Building $i deps
	dep=(`\$CC -MM $i.c | sed 's/\\\\//' | sed 's/.*://'`)
	cat >> Makefile << EOF
.build/$i.o: ${dep[@]} Makefile
	$CC -c -o .build/$i.o $i.c ${CFLAGS}

EOF
done